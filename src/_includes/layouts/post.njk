---
layout: layouts/base.njk
---

<article class="post-article">
  <!-- è¿”å›æŒ‰é’® -->
  <div class="post-navigation">
    <button class="back-button" onclick="goBack()">
      <span class="back-icon">â†</span>
      <span class="back-text">è¿”å›ä¸Šé¡µ</span>
    </button>
    <div class="breadcrumb">
      <a href="/">é¦–é¡µ</a>
      {% if '/recipes/' in page.url %}
        <span class="separator">â€º</span>
        <a href="/recipes">ç”œèœœé£Ÿè°±</a>
      {% elif '/travels/' in page.url %}
        <span class="separator">â€º</span>
        <a href="/travels">æ¼«æ¸¸åœ°å›¾</a>
      {% elif '/notes/' in page.url %}
        <span class="separator">â€º</span>
        <a href="/notes">çµæ„Ÿç¬”è®°</a>
      {% endif %}
      <span class="separator">â€º</span>
      <span class="current">{{ title }}</span>
    </div>
  </div>

  <!-- æ–‡ç« å¤´éƒ¨ -->
  <header class="post-header">
    {% if cover %}
      <div class="post-cover">
        <img src="{{ cover }}" alt="{{ title }}" loading="lazy">
        <div class="cover-overlay"></div>
      </div>
    {% endif %}
    
    <div class="post-meta-header">
      <div class="post-category">
        {% if category %}
          <span class="category-tag">{{ category }}</span>
        {% endif %}
        {% if date %}
          <span class="post-date">{{ date | postDate }}</span>
        {% endif %}
      </div>
      <h1 class="post-title">{{ title }}</h1>
      {% if description %}
        <p class="post-description">{{ description }}</p>
      {% endif %}
    </div>
  </header>

  <!-- æ–‡ç« å†…å®¹ -->
  <div class="post-content">
    <!-- é¡µé¢ä¸»è¦å†…å®¹ï¼ˆMarkdownæ­£æ–‡ï¼‰ -->
    {{ content | safe }}
    
    <!-- å›¾ç‰‡ç”»å»Š -->
    {% if gallery %}
      <section class="post-gallery">
        <h2 class="gallery-title">ğŸ“¸ ç²¾å½©ç¬é—´</h2>
        <div class="gallery-grid">
          {% for image_url in gallery %}
            <div class="gallery-item">
              <img src="{{ image_url }}" alt="å›¾ç‰‡ {{ loop.index }}" loading="lazy">
            </div>
          {% endfor %}
        </div>
      </section>
    {% endif %}
    
    <!-- å¦‚æœæœ‰ç»“æ„åŒ–æ•°æ®ï¼Œåˆ™æ˜¾ç¤ºé¢å¤–å†…å®¹ -->
    {% if ingredients or cooking_time or difficulty or steps or tips or quotes or reflection or links %}
    <div class="structured-content">
      <!-- é£Ÿè°±ç‰¹æœ‰çš„å†…å®¹ç»“æ„ -->
      {% if ingredients %}
        <section class="recipe-ingredients">
          <h2>ğŸ“ é£Ÿæå‡†å¤‡</h2>
          <div class="ingredients-list">
            {% for ingredient_group in ingredients %}
              {% if ':' in ingredient_group %}
                <div class="ingredient-group">
                  <h4>{{ ingredient_group | split(':') | first }}</h4>
                  <p>{{ ingredient_group | split(':') | last }}</p>
                </div>
              {% else %}
                <div class="ingredient-item">
                  <span class="ingredient-bullet">â€¢</span>
                  <span>{{ ingredient_group }}</span>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </section>
      {% endif %}

      {% if cooking_time or difficulty %}
        <section class="recipe-info">
          <h2>â±ï¸ åˆ¶ä½œä¿¡æ¯</h2>
          <div class="info-grid">
            {% if cooking_time %}
              <div class="info-item">
                <span class="info-icon">â°</span>
                <span class="info-label">åˆ¶ä½œæ—¶é—´</span>
                <span class="info-value">{{ cooking_time }}</span>
              </div>
            {% endif %}
            {% if difficulty %}
              <div class="info-item">
                <span class="info-icon">ğŸ“Š</span>
                <span class="info-label">éš¾åº¦ç­‰çº§</span>
                <span class="info-value">{{ difficulty }}</span>
              </div>
            {% endif %}
          </div>
        </section>
      {% endif %}

      {% if steps %}
        <section class="recipe-steps">
          <h2>ğŸ‘©â€ğŸ³ åˆ¶ä½œæ­¥éª¤</h2>
          <div class="steps-container">
            {% for step in steps %}
              <div class="step-item">
                <div class="step-number">{{ loop.index }}</div>
                <div class="step-content">{{ step | markdownify | safe }}</div>
              </div>
            {% endfor %}
          </div>
        </section>
      {% endif %}

      {% if tips %}
        <section class="recipe-tips">
          <h2>ğŸ’¡ åˆ¶ä½œè´´å£«</h2>
          <div class="tips-content">{{ tips | markdownify | safe }}</div>
        </section>
      {% endif %}

      <!-- è¯»ä¹¦ç¬”è®°ç‰¹æœ‰å†…å®¹ -->
      {% if quotes %}
        <section class="book-quotes">
          <h2>ğŸ’« ç»å…¸è¯­å½•</h2>
          <div class="quotes-list">
            {% for quote in quotes %}
              <blockquote class="quote-item">
                <p>{{ quote }}</p>
              </blockquote>
            {% endfor %}
          </div>
        </section>
      {% endif %}

      {% if reflection %}
        <section class="personal-reflection">
          <h2>ğŸ’­ ä¸ªäººæ„Ÿæ‚Ÿ</h2>
          <div class="reflection-content">{{ reflection | markdownify | safe }}</div>
        </section>
      {% endif %}

      {% if links %}
        <section class="related-links">
          <h2>ğŸ”— ç›¸å…³é“¾æ¥</h2>
          <div class="links-list">
            {% for link in links %}
              <div class="link-item">
                <a href="{{ link.url }}" target="_blank" rel="noopener noreferrer">
                  <span class="link-icon">ğŸŒ</span>
                  <span class="link-title">{{ link.title }}</span>
                  <span class="link-external">â†—</span>
                </a>
              </div>
            {% endfor %}
          </div>
        </section>
      {% endif %}
    </div>
    {% endif %}
  </div>

  <!-- æ–‡ç« åº•éƒ¨ -->
  <footer class="post-footer">
    {% if tags %}
      <div class="post-tags">
        <span class="tags-label">ğŸ·ï¸ æ ‡ç­¾ï¼š</span>
        <div class="tags-list">
          {% for tag in tags %}
            <span class="tag">{{ tag }}</span>
          {% endfor %}
        </div>
      </div>
    {% endif %}
    
    <div class="post-actions">
      <button class="action-button" onclick="sharePost()">
        <span class="button-icon">ğŸ“¤</span>
        <span class="button-text">åˆ†äº«æ–‡ç« </span>
      </button>
      <button class="action-button" onclick="toggleComments()">
        <span class="button-icon">ğŸ’¬</span>
        <span class="button-text">ç•™è¨€è®¨è®º</span>
      </button>
    </div>
  </footer>
</article>

<!-- æ–‡ç« ç‹¬ç«‹è¯„è®ºåŒº -->
<section id="post-comments" class="post-comments-section">
  <div class="comments-container">
    <h2 class="comments-title">ğŸ’¬ ç•™è¨€è®¨è®º</h2>
    <div class="comments-subtitle">
      å…³äºã€Š{{ title }}ã€‹çš„æƒ³æ³•å’Œæ„Ÿæ‚Ÿ
    </div>
    
    <!-- ç•™è¨€è¡¨å• -->
    <div class="comment-form">
      <h3>å†™ä¸‹ä½ çš„æƒ³æ³•</h3>
      <form id="comment-form" class="comment-form-inner">
        <div class="form-row">
          <div class="form-group">
            <label for="comment-name">æ˜µç§°</label>
            <input type="text" id="comment-name" name="name" required placeholder="è¯·è¾“å…¥ä½ çš„æ˜µç§°">
          </div>
          <div class="form-group">
            <label for="comment-email">é‚®ç®±</label>
            <input type="email" id="comment-email" name="email" required placeholder="é‚®ç®±ä¸ä¼šå…¬å¼€æ˜¾ç¤º">
          </div>
        </div>
        
        <div class="form-group full-width">
          <label for="comment-content">ç•™è¨€å†…å®¹</label>
          <textarea id="comment-content" name="content" required placeholder="åˆ†äº«ä½ å¯¹è¿™ç¯‡æ–‡ç« çš„æƒ³æ³•..." rows="4"></textarea>
        </div>
        
        <div class="form-actions">
          <button type="submit" class="submit-btn">
            <span class="btn-icon">ğŸŒ¸</span>
            å‘å¸ƒç•™è¨€
          </button>
          <button type="reset" class="reset-btn">
            æ¸…ç©ºå†…å®¹
          </button>
        </div>
      </form>
    </div>
    
    <!-- ç•™è¨€åˆ—è¡¨ -->
    <div class="comments-list">
      <h3>å…¨éƒ¨ç•™è¨€</h3>
      <div id="comments-container" class="comments-container-inner">
        <!-- ç•™è¨€å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
        <div class="no-comments">
          <div class="no-comments-icon">ğŸ’­</div>
          <p>è¿˜æ²¡æœ‰ç•™è¨€ï¼Œæ¥åšç¬¬ä¸€ä¸ªåˆ†äº«æƒ³æ³•çš„äººå§ï¼</p>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ç•™è¨€åŠŸèƒ½JavaScript -->
<script>
// ç•™è¨€æ•°æ®ç®¡ç†
class PostComments {
  constructor() {
    this.postId = window.location.pathname;
    this.comments = this.loadComments();
    this.init();
  }
  
  init() {
    this.bindEvents();
    this.renderComments();
  }
  
  // åŠ è½½è¯¥æ–‡ç« çš„ç•™è¨€
  loadComments() {
    const allComments = JSON.parse(localStorage.getItem('petal-diary-comments') || '{}');
    return allComments[this.postId] || [];
  }
  
  // ä¿å­˜ç•™è¨€
  saveComments() {
    const allComments = JSON.parse(localStorage.getItem('petal-diary-comments') || '{}');
    allComments[this.postId] = this.comments;
    localStorage.setItem('petal-diary-comments', JSON.stringify(allComments));
  }
  
  // ç»‘å®šäº‹ä»¶
  bindEvents() {
    const form = document.getElementById('comment-form');
    if (form) {
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        this.addComment();
      });
    }
  }
  
  // æ·»åŠ ç•™è¨€
  addComment() {
    const nameInput = document.getElementById('comment-name');
    const emailInput = document.getElementById('comment-email');
    const contentInput = document.getElementById('comment-content');
    
    const comment = {
      id: Date.now(),
      name: nameInput.value.trim(),
      email: emailInput.value.trim(),
      content: contentInput.value.trim(),
      timestamp: new Date().toISOString(),
      postId: this.postId
    };
    
    // éªŒè¯
    if (!comment.name || !comment.email || !comment.content) {
      showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
      return;
    }
    
    // æ·»åŠ åˆ°ç•™è¨€åˆ—è¡¨
    this.comments.unshift(comment);
    this.saveComments();
    this.renderComments();
    
    // æ¸…ç©ºè¡¨å•
    document.getElementById('comment-form').reset();
    
    // æ˜¾ç¤ºæˆåŠŸæç¤º
    showToast('ç•™è¨€å‘å¸ƒæˆåŠŸï¼æ„Ÿè°¢ä½ çš„åˆ†äº« ğŸŒ¸');
    
    // æ»šåŠ¨åˆ°ç•™è¨€åˆ—è¡¨
    setTimeout(() => {
      document.getElementById('comments-container').scrollIntoView({ behavior: 'smooth' });
    }, 500);
  }
  
  // æ¸²æŸ“ç•™è¨€åˆ—è¡¨
  renderComments() {
    const container = document.getElementById('comments-container');
    
    if (this.comments.length === 0) {
      container.innerHTML = `
        <div class="no-comments">
          <div class="no-comments-icon">ğŸ’­</div>
          <p>è¿˜æ²¡æœ‰ç•™è¨€ï¼Œæ¥åšç¬¬ä¸€ä¸ªåˆ†äº«æƒ³æ³•çš„äººå§ï¼</p>
        </div>
      `;
      return;
    }
    
    const commentsHTML = this.comments.map(comment => this.createCommentHTML(comment)).join('');
    container.innerHTML = commentsHTML;
    
    // ç»‘å®šåˆ é™¤å’Œå›å¤æŒ‰é’®äº‹ä»¶
    this.bindCommentActions();
  }
  
  // åˆ›å»ºå•ä¸ªç•™è¨€HTML
  createCommentHTML(comment) {
    const date = new Date(comment.timestamp);
    const dateStr = this.formatDate(date);
    
    return `
      <div class="comment-item" data-comment-id="${comment.id}">
        <div class="comment-header">
          <div class="comment-avatar">
            <span class="avatar-emoji">ğŸŒ¸</span>
          </div>
          <div class="comment-meta">
            <div class="comment-author">${this.escapeHtml(comment.name)}</div>
            <div class="comment-date">${dateStr}</div>
          </div>
          <div class="comment-actions">
            <button class="comment-btn reply-btn" onclick="postComments.replyToComment('${comment.id}')">
              ğŸ’¬ å›å¤
            </button>
            <button class="comment-btn delete-btn" onclick="postComments.deleteComment('${comment.id}')">
              ğŸ—‘ï¸ åˆ é™¤
            </button>
          </div>
        </div>
        <div class="comment-content">${this.escapeHtml(comment.content)}</div>
      </div>
    `;
  }
  
  // åˆ é™¤ç•™è¨€
  deleteComment(commentId) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç•™è¨€å—ï¼Ÿ')) {
      this.comments = this.comments.filter(c => c.id != commentId);
      this.saveComments();
      this.renderComments();
      showToast('ç•™è¨€å·²åˆ é™¤');
    }
  }
  
  // å›å¤ç•™è¨€
  replyToComment(commentId) {
    const comment = this.comments.find(c => c.id == commentId);
    if (comment) {
      const contentInput = document.getElementById('comment-content');
      contentInput.value = `@${comment.name} ${contentInput.value}`;
      contentInput.focus();
    }
  }
  
  // æ ¼å¼åŒ–æ—¥æœŸ
  formatDate(date) {
    const now = new Date();
    const diff = now - date;
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    
    if (days === 0) {
      const hours = Math.floor(diff / (1000 * 60 * 60));
      if (hours === 0) {
        const minutes = Math.floor(diff / (1000 * 60));
        return minutes === 0 ? 'åˆšåˆš' : `${minutes}åˆ†é’Ÿå‰`;
      }
      return `${hours}å°æ—¶å‰`;
    } else if (days === 1) {
      return 'æ˜¨å¤©';
    } else if (days < 7) {
      return `${days}å¤©å‰`;
    } else {
      return date.toLocaleDateString('zh-CN');
    }
  }
  
  // HTMLè½¬ä¹‰
  escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ç•™è¨€åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
  window.postComments = new PostComments();
});
</script>

<!-- JavaScript -->
<script>
function goBack() {
  if (document.referrer && document.referrer.includes(window.location.hostname)) {
    history.back();
  } else {
    // æ ¹æ®å½“å‰é¡µé¢ç±»å‹è¿”å›åˆ°å¯¹åº”çš„åˆ—è¡¨é¡µ
    const currentPath = window.location.pathname;
    if (currentPath.includes('/recipes/')) {
      window.location.href = '/recipes';
    } else if (currentPath.includes('/travels/')) {
      window.location.href = '/travels';
    } else if (currentPath.includes('/notes/')) {
      window.location.href = '/notes';
    } else {
      window.location.href = '/';
    }
  }
}

function sharePost() {
  if (navigator.share) {
    navigator.share({
      title: document.title,
      text: document.querySelector('meta[name="description"]')?.content || '',
      url: window.location.href
    }).catch(err => console.log('åˆ†äº«å¤±è´¥:', err));
  } else {
    // å¤åˆ¶é“¾æ¥åˆ°å‰ªè´´æ¿
    navigator.clipboard.writeText(window.location.href).then(() => {
      showToast('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
    }).catch(() => {
      showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥');
    });
  }
}

function toggleComments() {
  const commentsSection = document.getElementById('post-comments');
  if (commentsSection) {
    commentsSection.scrollIntoView({ behavior: 'smooth' });
  }
}

function showToast(message) {
  const toast = document.createElement('div');
  toast.className = 'toast-message';
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.classList.add('show');
  }, 100);
  
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => {
      document.body.removeChild(toast);
    }, 300);
  }, 3000);
}

// é¡µé¢åŠ è½½å®Œæˆåçš„åŠ¨ç”»
document.addEventListener('DOMContentLoaded', function() {
  // ä¸ºæ­¥éª¤æ·»åŠ æ¸å…¥åŠ¨ç”»
  const steps = document.querySelectorAll('.step-item');
  steps.forEach((step, index) => {
    setTimeout(() => {
      step.style.opacity = '1';
      step.style.transform = 'translateY(0)';
    }, index * 100);
  });
});
</script>